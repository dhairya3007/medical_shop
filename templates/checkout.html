{% extends 'base.html' %}

{% block content %}
<style>
/* General page styles */
.container {
    max-width: 1200px;
}
.card {
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
}
.card-header {
    background: #f1f5f9;
    font-weight: 600;
}
.card-body {
    padding: 1.5rem;
}
.btn {
    border-radius: 12px;
}

/* Print-only styles */
@media print {
    body * { visibility: hidden; }
    #printable, #printable * { visibility: visible; }
    #printable { position: absolute; top: 0; left: 0; width: 100%; }
    button { display: none; }
}
</style>

<div class="container py-5">
    <h1 class="text-center mb-5">Checkout</h1>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Order Items</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <h6 class="mb-0">{{ item.medicine.name }}</h6>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="fw-bold">x{{ item.quantity }}</span>
                        </div>
                        <div class="col-md-3 text-end">
                            <span class="fw-bold">₹{{ item.total }}</span>
                        </div>
                    </div>
                    <hr>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Payment Summary</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="checkoutForm">
                        {% csrf_token %}

                        {% if user.is_staff %}
                        <div class="mb-3">
                            <label for="discount" class="form-label">Discount Percentage</label>
                            <div class="input-group">
                                <input type="number" class="form-control discount-input" id="discount"
                                       name="discount" min="0" max="100" value="0" step="0.1" oninput="calculateDiscount()">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹{{ total }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Discount:</span>
                            <span id="discountAmount">₹0.00</span>
                        </div>
                        {% else %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹{{ total }}</span>
                        </div>
                        {% endif %}

                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-4">
                            <span>Total:</span>
                            <span id="finalAmount">₹{{ total }}</span>
                            <input type="hidden" id="finalAmountInput" name="final_amount" value="{{ total }}">
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg mb-3">
                            <i class="fas fa-check-circle me-2"></i>Complete Purchase
                        </button>

                        <button type="button" class="btn btn-outline-primary w-100 btn-lg" onclick="printBill()">
                            <i class="fas fa-print me-2"></i>Print / Save as PDF
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Printable bill section -->
<div id="printable" style="display:none;">
    <h2>Purchase Bill</h2>
    <p><strong>Date & Time:</strong> {{ now|date:"d-m-Y H:i:s" }}</p>
    <table width="100%" border="1" cellspacing="0" cellpadding="5">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td>{{ item.medicine.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>₹{{ item.total }}</td>
            </tr>
            {% endfor %}
            <tr>
                <td colspan="2" style="text-align:right;"><strong>Total:</strong></td>
                <td>₹{{ total }}</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
function calculateDiscount() {
    const total = parseFloat('{{ total }}');
    const discountInput = document.getElementById('discount');
    const discountAmountElement = document.getElementById('discountAmount');
    const finalAmountElement = document.getElementById('finalAmount');

    if (discountInput && discountAmountElement && finalAmountElement) {
        const discount = parseFloat(discountInput.value) || 0;
        const discountAmount = total * (discount / 100);
        const finalAmount = total - discountAmount;

        discountAmountElement.textContent = '₹' + discountAmount.toFixed(2);
        finalAmountElement.textContent = '₹' + finalAmount.toFixed(2);

        document.getElementById('finalAmountInput').value = finalAmount.toFixed(2);
    }
}

// Initialize discount
document.addEventListener('DOMContentLoaded', function() {
    calculateDiscount();
});

function printBill() {
    const printContent = document.getElementById('printable').innerHTML;
    const originalContent = document.body.innerHTML;

    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload(); // reload to restore JS and CSS
}
</script>
{% endblock %}
